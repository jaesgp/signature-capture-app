<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signature Capture App</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.5/dist/signature_pad.umd.min.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <link rel="manifest" href="/manifest.json">
    <style>
        /* Tailwind CSS classes embedded directly */
        .font-roboto { font-family: 'Roboto', sans-serif; }
        .bg-\[\#f0f4c3\] { background-color: #f0f4c3; }
        .flex { display: flex; }
        .justify-center { justify-content: center; }
        .items-center { align-items: center; }
        .min-h-screen { min-height: 100vh; }
        .p-4 { padding: 1rem; }
        .box-border { box-sizing: border-box; }
        .container { background-color: #003366; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); width: 90%; max-width: 600px; text-align: center; }
        .text-\[\#ffcc00\] { color: #ffcc00; }
        .mb-5 { margin-bottom: 1.25rem; }
        .text-2xl { font-size: 1.5rem; line-height: 2rem; }
        .font-bold { font-weight: 700; }
        .form-group { margin-bottom: 1rem; text-align: left; }
        .block { display: block; }
        .mb-1 { margin-bottom: 0.25rem; }
        .text-white { color: #ffffff; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .font-medium { font-weight: 500; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .w-full { width: 100%; }
        .p-2 { padding: 0.5rem; }
        .border { border-width: 1px; }
        .border-gray-300 { border-color: #d1d5db; }
        .rounded-md { border-radius: 0.375rem; }
        .box-border { box-sizing: border-box; }
        .text-base { font-size: 1rem; line-height: 1.5rem; }
        .transition-colors { transition-property: background-color, border-color, color, fill, stroke; transition-duration: 0.15s; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); }
        .focus\:border-\[\#ffcc00\]:focus { border-color: #ffcc00; }
        .outline-none:focus { outline: 2px solid transparent; outline-offset: 2px; } /* Improved outline for accessibility */
        .bg-white { background-color: #ffffff; }
        .text-gray-800 { color: #1f2937; }
        .flex-1 { flex: 1 1 0%; }
        .rounded-l-md { border-top-left-radius: 0.375rem; border-bottom-left-radius: 0.375rem; }
        .border-r-0 { border-right-width: 0px; }
        .bg-gray-200 { background-color: #e5e7eb; }
        .rounded-r-md { border-top-right-radius: 0.375rem; border-bottom-right-radius: 0.375rem; }
        .text-gray-600 { color: #4b5563; }
        .relative { position: relative; }
        .h-48 { height: 12rem; }
        .inset-0 { top: 0px; right: 0px; bottom: 0px; left: 0px; }
        .absolute { position: absolute; }
        .text-base { font-size: 1rem; line-height: 1.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .flex-wrap { flex-wrap: wrap; }
        .gap-4 { gap: 1rem; }
        .mt-2 { margin-top: 0.5rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
        .bg-\[\#f39c12\] { background-color: #f39c12; } /* Orange */
        .hover\:bg-\[\#e67e22\]:hover { background-color: #e67e22; }
        .bg-\[\#ffcc00\] { background-color: #ffcc00; } /* Yellow */
        .text-\[\#003366\] { color: #003366; } /* Dark blue */
        .hover\:bg-\[\#e0b100\]:hover { background-color: #e0b100; }
        .bg-\[\#8e44ad\] { background-color: #8e44ad; } /* Purple */
        .hover\:bg-\[\#7a2d91\]:hover { background-color: #7a2d91; }
        @media (max-width: 768px) {
            .container { width: 95%; }
            .min-w-\[150px\] { min-width: unset; } /* Allow buttons to shrink */
            .w-full { width: 100%; }
            .mb-10 { margin-bottom: 2.5rem; }
            .flex-col { flex-direction: column; }
        }
    </style>
</head>
<body class="font-roboto bg-[#f0f4c3] flex justify-center items-center min-h-screen p-4 box-border">

    <div id="root"></div>

    <script>
        const { useState, useEffect, useRef, useCallback } = React;

        // Main App Component
        function App() {
            const [rwoNumber, setRwoNumber] = useState('');
            const [expectedOnSite, setExpectedOnSite] = useState('');
            const [amountOnSite, setAmountOnSite] = useState('');
            const [difference, setDifference] = useState('0 Rolls'); // Initialize difference
            const [customerName, setCustomerName] = useState('');
            const [currentDateTime, setCurrentDateTime] = useState('');

            const signaturePadRef = useRef(null);
            const signatureCanvasRef = useRef(null);

            // Effect to initialize SignaturePad
            useEffect(() => {
                if (signatureCanvasRef.current) {
                    signaturePadRef.current = new SignaturePad(signatureCanvasRef.current, {
                        backgroundColor: 'rgba(255, 255, 255, 1)', // White background for signature pad
                        penColor: 'rgb(0, 0, 0)' // Black pen color
                    });
                }
            }, []);

            // Effect to update date and time display
            useEffect(() => {
                const updateDateTime = () => {
                    const now = new Date();
                    const formattedDate = `${now.getDate().toString().padStart(2, '0')}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getFullYear()}`;
                    const formattedTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                    setCurrentDateTime("Date/Time: " + formattedDate + " " + formattedTime);
                };
                updateDateTime();
                const intervalId = setInterval(updateDateTime, 1000);
                return () => clearInterval(intervalId);
            }, []);

            // Callback to update difference based on expected and amount
            const updateDifference = useCallback(() => {
                const expected = parseInt(expectedOnSite) || 0;
                const amount = parseInt(amountOnSite) || 0;
                const diff = expected - amount;
                let diffText = Math.abs(diff).toString(); // Always show absolute value

                if (diff > 0) {
                    diffText += " Rolls missing";
                } else if (diff < 0) {
                    diffText += " Rolls up on site";
                } else {
                    diffText += " Rolls"; // For zero difference
                }
                setDifference(diffText);
            }, [expectedOnSite, amountOnSite]);

            useEffect(() => {
                updateDifference();
            }, [expectedOnSite, amountOnSite, updateDifference]);

            // Function to clear the signature pad
            const handleClearSignature = () => {
                if (signaturePadRef.current) {
                    signaturePadRef.current.clear();
                }
            };

            // Function to clear all inputs and signature
            const handleClearAll = () => {
                setRwoNumber('');
                setExpectedOnSite('');
                setAmountOnSite('');
                setCustomerName('');
                setDifference('0 Rolls'); // Reset difference display
                handleClearSignature();
            };

            // Function to handle download
            const handleDownload = () => {
                if (signaturePadRef.current.isEmpty() || !rwoNumber || !expectedOnSite || !amountOnSite || !customerName) {
                    alert('Please fill in all the fields and provide a signature.');
                    return;
                }
                if (rwoNumber.length !== 6) {
                    alert('RWO Number must be 6 digits.');
                    return;
                }

                const signatureDataURL = signaturePadRef.current.toDataURL('image/png');

                // Create a temporary canvas for combining information
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();

                img.onload = () => {
                    const now = new Date();
                    const formattedDate = `${now.getDate().toString().padStart(2, '0')}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getFullYear()}`;
                    const formattedTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

                    // Set canvas dimensions
                    canvas.width = Math.max(img.width + 40, 600); // Add padding, ensure min width
                    canvas.height = img.height + 200; // Height for text + signature + padding

                    // Draw white background
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    // Draw title
                    ctx.font = '700 24px Roboto'; // Bold for title
                    ctx.fillStyle = '#ffcc00';
                    ctx.textAlign = 'center';
                    ctx.fillText('Stock Discrepancy', canvas.width / 2, 30);

                    // Draw details
                    ctx.font = '400 16px Roboto'; // Regular weight for details
                    ctx.fillStyle = 'black';
                    ctx.textAlign = 'left'; // Align text left for details

                    let textY = 60;
                    const textX = 20; // Left padding for text

                    ctx.fillText("RWO: " + rwoNumber, textX, textY);
                    textY += 20;
                    ctx.fillText("Expected on Site: " + expectedOnSite + " Rolls", textX, textY);
                    textY += 20;
                    ctx.fillText("Amount on Site: " + amountOnSite + " Rolls", textX, textY);
                    textY += 20;
                    ctx.fillText("Difference: " + difference, textX, textY);
                    textY += 20;
                    ctx.fillText("Full Customer Name: " + customerName, textX, textY);

                    // Draw signature
                    const signatureY = textY + 20; // Position signature below text
                    ctx.drawImage(img, (canvas.width - img.width) / 2, signatureY);

                    // Draw Date/Time at the bottom
                    ctx.font = '400 14px Roboto';
                    ctx.fillStyle = 'black';
                    ctx.textAlign = 'center';
                    ctx.fillText("Date/Time: " + formattedDate + " " + formattedTime, canvas.width / 2, canvas.height - 20);

                    // Trigger download
                    const combinedDataURL = canvas.toDataURL('image/png');
                    const a = document.createElement('a');
                    a.href = combinedDataURL;
                    a.download = "stock_discrepancy_RWO_" + rwoNumber + ".png";
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                };
                img.src = signatureDataURL;
            };

            // React component rendering
            return React.createElement("div", { className: "container bg-[#003366] p-8 rounded-xl shadow-lg w-11/12 max-w-xl text-center" },
                React.createElement("h1", { className: "text-[#ffcc00] mb-5 text-2xl font-bold" }, "Stock Discrepancy"),
                React.createElement("div", { className: "form-group mb-4 text-left" },
                    React.createElement("label", { htmlFor: "rwoNumber", className: "block mb-1 text-white text-sm font-medium" }, "RWO:"),
                    React.createElement("div", { className: "flex items-center" },
                        React.createElement("input", {
                            type: "number",
                            id: "rwoNumber",
                            placeholder: "Enter 6-digit Number",
                            maxLength: "6",
                            value: rwoNumber,
                            onChange: (e) => setRwoNumber(e.target.value.slice(0, 6)),
                            className: "w-full p-2 border border-gray-300 rounded-md box-border text-base transition-colors focus:border-[#ffcc00] outline-none bg-white text-gray-800"
                        })
                    )
                ),
                React.createElement("div", { className: "form-group mb-4 text-left" },
                    React.createElement("label", { htmlFor: "expectedOnSite", className: "block mb-1 text-white text-sm font-medium" }, "Expected on Site:"),
                    React.createElement("div", { className: "flex items-center" },
                        React.createElement("input", {
                            type: "number",
                            id: "expectedOnSite",
                            placeholder: "Enter Amount",
                            value: expectedOnSite,
                            onChange: (e) => setExpectedOnSite(e.target.value),
                            className: "flex-1 p-2 border border-gray-300 rounded-l-md box-border text-base transition-colors focus:border-[#ffcc00] outline-none bg-white text-gray-800"
                        }),
                        React.createElement("span", { className: "bg-gray-200 border border-gray-300 p-2 rounded-r-md text-base text-gray-600" }, "Rolls")
                    )
                ),
                React.createElement("div", { className: "form-group mb-4 text-left" },
                    React.createElement("label", { htmlFor: "amountOnSite", className: "block mb-1 text-white text-sm font-medium" }, "Amount on Site:"),
                    React.createElement("div", { className: "flex items-center" },
                        React.createElement("input", {
                            type: "number",
                            id: "amountOnSite",
                            placeholder: "Enter Amount",
                            value: amountOnSite,
                            onChange: (e) => setAmountOnSite(e.target.value),
                            className: "flex-1 p-2 border border-gray-300 rounded-l-md box-border text-base transition-colors focus:border-[#ffcc00] outline-none bg-white text-gray-800"
                        }),
                        React.createElement("span", { className: "bg-gray-200 border border-gray-300 p-2 rounded-r-md text-base text-gray-600" }, "Rolls")
                    )
                ),
                React.createElement("div", { className: "form-group mb-4 text-left" },
                    React.createElement("label", { htmlFor: "difference", className: "block mb-1 text-white text-sm font-medium" }, "Difference:"),
                    React.createElement("input", {
                        type: "text",
                        id: "difference",
                        value: difference,
                        readOnly: true,
                        className: "w-full p-2 border border-gray-300 rounded-md box-border text-base bg-white text-gray-800"
                    })
                ),
                React.createElement("div", { className: "form-group mb-4 text-left" },
                    React.createElement("label", { htmlFor: "customerName", className: "block mb-1 text-white text-sm font-medium" }, "Full Customer Name:"),
                    React.createElement("input", {
                        type: "text",
                        id: "customerName",
                        placeholder: "Enter Customer Name",
                        value: customerName,
                        onChange: (e) => setCustomerName(e.target.value),
                        className: "w-full p-2 border border-gray-300 rounded-md box-border text-base transition-colors focus:border-[#ffcc00] outline-none bg-white text-gray-800"
                    })
                ),
                React.createElement("div", { className: "form-group mb-4 text-left" },
                    React.createElement("label", { className: "block mb-1 text-white text-sm font-medium" }, "Output (Signature):"),
                    React.createElement("div", { className: "relative w-full h-48 border-2 border-gray-300 rounded-md mb-5 bg-white" },
                        React.createElement("canvas", { ref: signatureCanvasRef, className: "absolute inset-0 w-full h-full" })
                    )
                ),
                React.createElement("div", { id: "date-time", className: "text-white text-base mb-4" }, currentDateTime),
                React.createElement("div", { className: "flex flex-wrap justify-center gap-4 mt-2" },
                    React.createElement("button", {
                        onClick: handleClearSignature,
                        className: "py-3 px-6 bg-[#f39c12] text-white rounded-md cursor-pointer text-base transition-colors hover:bg-[#e67e22] min-w-[150px]"
                    }, "Clear Signature"),
                    React.createElement("button", {
                        onClick: handleDownload,
                        className: "py-3 px-6 bg-[#ffcc00] text-[#003366] rounded-md cursor-pointer text-base transition-colors hover:bg-[#e0b100] min-w-[150px]"
                    }, "Download"),
                    React.createElement("button", {
                        onClick: handleClearAll,
                        className: "py-3 px-6 bg-[#8e44ad] text-white rounded-md cursor-pointer text-base transition-colors hover:bg-[#7a2d91] min-w-[150px]"
                    }, "Clear All")
                )
            );
        }

        // Render the App component
        ReactDOM.render(React.createElement(App, null), document.getElementById('root'));
    </script>

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/service-worker.js')
            .then(registration => {
              console.log('ServiceWorker registration successful with scope: ', registration.scope);
            })
            .catch(err => {
              console.log('ServiceWorker registration failed: ', err);
            });
        });
      }
    </script>
</body>
</html>
